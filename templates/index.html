{% extends 'base.html' %}

{% block content %}
<!-- Welcome Section (Local Only) -->
<div id="welcome-section" class="card">
  <img src="{{ url_for('static', filename='elf.png') }}" alt="Friendly Christmas Elf" class="elf-image">
  <div class="content">
    <h2>Hello There, Explorer!</h2>
    <p>
      Welcome to the <strong>Epic Dias Family Christmas Gift Exchange of 2025</strong>!
    </p>
    <p>
      We are going to play a game to find our gifts. Join the session to sync up with everyone else!
    </p>
    <button onclick="enterGame()" class="btn">Join the Hunt! üéÅ</button>
  </div>
</div>

<!-- Game Section (Synced) -->
<div id="game-section" class="card" style="display: none;">
  <img src="{{ url_for('static', filename='elf.png') }}" alt="Elf" class="elf-image-small">

  <!-- STORY SEGMENT VISUALIZER -->
  <div id="segment-container"
    style="background-color: #fff8e1; border: 2px dashed var(--christmas-red); padding: 15px; margin: 15px 0; border-radius: 10px; display:none;">
    <h3 style="color: var(--christmas-green); margin-top: 0; font-size: 1.2rem;">The Story So Far:</h3>
    <p id="segment-text" style="font-style: italic; font-family: 'Georgia', serif;"></p>
    <div id="segment-loading" style="display: none; color: #666;">
      <img src="{{ url_for('static', filename='santa_delivery.png') }}" alt="Loading"
        style="width: 50px; vertical-align: middle;">
      <em>The elves are writing...</em>
    </div>
  </div>

  <!-- Phase: INPUT -->
  <div id="phase-input" style="display: none;">
    <h2>Step <span id="step-number">...</span></h2>

    <p style="color: #666; margin-bottom: 20px;">Use the boxes below to fill in the blanks. Everyone can type at the
      same time!</p>

    <!-- Dynamic Inputs Container -->
    <div id="inputs-container"></div>

    <div style="margin-top: 20px; font-weight: bold; color: var(--christmas-gold);">
      ‚è≥ Wait for the Game Master to approve everyone's answers!
    </div>
  </div>

  <!-- Phase: HINT -->
  <div id="phase-hint" style="display: none;">
    <h2>Step Complete!</h2>
    <div class="clue-box">
      <p><strong>Next Hint:</strong></p>
      <p id="hint-text" style="font-size: 1.4rem;">...</p>
    </div>
    <p style="margin-top: 1rem; font-style: italic; color: #666;">
      Search for the QR code to unlock the next step!
    </p>
  </div>

  <!-- Phase: COMPLETED -->
  <div id="phase-completed" style="display: none;">
    <h2>üéâ Hunt Completed! üéâ</h2>
    <p>Here are the words you gathered along the way:</p>

    <!-- Story Section -->
    <div id="story-container"
      style="background-color: #fff8e1; border: 2px dashed var(--christmas-red); padding: 15px; margin: 15px 0; border-radius: 10px;">
      <h3 style="color: var(--christmas-green); margin-top: 0;">A Christmas Tale</h3>
      <p id="story-text" style="font-style: italic; white-space: pre-wrap; font-family: 'Georgia', serif;"></p>
    </div>

    <table style="width: 100%; margin-top: 1rem; border-collapse: collapse;">
      <thead>
        <tr style="background: var(--christmas-green); color: white;">
          <th style="padding: 8px;">Cousin</th>
          <th style="padding: 8px;">Type</th>
          <th style="padding: 8px;">Word</th>
        </tr>
      </thead>
      <tbody id="results-body">
      </tbody>
    </table>
  </div>
</div>

<script>
  const API_URL = '/api';
  let isTyping = false;

  function enterGame() {
    document.getElementById('welcome-section').style.display = 'none';
    document.getElementById('game-section').style.display = 'block';
    // Start polling
    setInterval(pollStatus, 1000); // Check every second
    pollStatus(); // Immediate check
  }

  async function pollStatus() {
    try {
      const response = await fetch(`${API_URL}/status`);
      const data = await response.json();
      updateUI(data);
    } catch (error) {
      console.error('Error polling status:', error);
    }
  }

  function updateUI(data) {
    // Hide all phases first
    document.getElementById('phase-input').style.display = 'none';
    document.getElementById('phase-hint').style.display = 'none';
    document.getElementById('phase-completed').style.display = 'none';

    // 1. Story Segment Logic
    const segmentContainer = document.getElementById('segment-container');
    const segmentText = document.getElementById('segment-text');
    const segmentLoading = document.getElementById('segment-loading');

    if (data.latest_segment || data.is_generating || data.story) {
      segmentContainer.style.display = 'block';
    }

    if (data.is_generating) {
      segmentText.style.display = 'none';
      segmentLoading.style.display = 'block';
    } else {
      segmentLoading.style.display = 'none';
      segmentText.style.display = 'block';
      segmentText.innerHTML = data.latest_segment || "";
    }

    // 2. Phase Logic
    if (data.phase === 'INPUT') {
      document.getElementById('phase-input').style.display = 'block';
      document.getElementById('step-number').textContent = data.step_number;

      // Render Inputs
      renderInputs(data.inputs);

    } else if (data.phase === 'HINT') {
      document.getElementById('phase-hint').style.display = 'block';
      document.getElementById('hint-text').textContent = data.hint;

    } else if (data.phase === 'COMPLETED') {
      document.getElementById('phase-completed').style.display = 'block';
      segmentContainer.style.display = 'none';

      const storyText = document.getElementById('story-text');
      if (data.is_generating) {
        storyText.innerHTML = `
              <div style="text-align: center;">
                <p style="font-size: 1.5rem; color: var(--christmas-green); margin-bottom: 20px;">Finishing the masterpiece...</p>
                 <img src="{{ url_for('static', filename='santa_delivery.png') }}" alt="Santa Delivering Message" style="max-width: 100%; height: auto; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
              </div>
            `;
      } else {
        storyText.innerHTML = data.story || data.full_story;
      }

      renderResults(data.results);
    }
  }

  function renderInputs(serverInputs) {
    const container = document.getElementById('inputs-container');

    // If count mismatches, rebuild entirely. Simple reconciliation.
    if (container.children.length !== serverInputs.length) {
      container.innerHTML = '';
      serverInputs.forEach((inputState, idx) => {
        const div = document.createElement('div');
        div.className = 'input-card';
        div.style.cssText = "background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #ddd; text-align: left;";

        div.innerHTML = `
                  <div style="font-weight: bold; color: var(--christmas-green); margin-bottom: 5px;">
                      ${inputState.cousin}
                  </div>
                  <label style="font-size: 0.9rem; color: #666;">${inputState.label}</label>
                  <input type="text" id="input-${idx}" 
                      style="width: 100%; padding: 10px; font-size: 1.1rem; border: 2px solid #eee; border-radius: 5px; margin-top: 5px;"
                      placeholder="Type a ${inputState.type}..."
                  >
              `;
        container.appendChild(div);

        // Attach listener
        const inputEl = div.querySelector('input');
        inputEl.addEventListener('input', (e) => {
          handleInput(idx, e.target.value);
        });
      });
    }

    // Update values
    serverInputs.forEach((inputState, idx) => {
      const el = document.getElementById(`input-${idx}`);
      if (el) {
        // Only update if NOT focused, to allow smooth typing without overwrites
        // OR if value is wildly different (maybe someone else finished it?)
        if (document.activeElement !== el) {
          el.value = inputState.value;
        }
      }
    });
  }

  // Debounced Input Sender
  let debounceTimer;
  function handleInput(index, value) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      sendUpdate(index, value);
    }, 300); // 300ms debounce
  }

  async function sendUpdate(index, value) {
    try {
      await fetch(`${API_URL}/update_input`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: index, value: value })
      });
    } catch (err) {
      console.error("Failed to sync input", err);
    }
  }

  function renderResults(results) {
    const tbody = document.getElementById('results-body');
    if (tbody.innerHTML.trim() !== '') return;

    results.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${row.cousin}</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${row.type}</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold; color: var(--christmas-red);">${row.word}</td>
            `;
      tbody.appendChild(tr);
    });
  }

  {% if auto_join %}
  window.addEventListener('load', function () {
    enterGame();
  });
  {% endif %}
</script>

<style>
  .elf-image-small {
    max-width: 150px;
    width: 100%;
    height: auto;
    border-radius: 15px;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}